{% assign block_settings = block.settings %}
{% assign addon_product = all_products[block_settings.addon_product] %}

{% if addon_product and addon_product != blank %}
  {% liquid
    assign addon_variant = addon_product.selected_or_first_available_variant
    assign addon_image = addon_variant.featured_image | default: addon_product.featured_image
    assign addon_price = addon_variant.price
    assign addon_compare_price = addon_variant.compare_at_price
  %}

  <div 
    class="product-addon"
    data-addon-product-id="{{ addon_product.id }}"
    data-addon-variant-id="{{ addon_variant.id }}"
    data-addon-price="{{ addon_price }}"
  >
    {% if block_settings.show_title %}
      <h3 class="product-addon__title">{{ block_settings.title | default: 'Add-ons' }}</h3>
    {% endif %}
    
    <div class="product-addon__item">
      <label for="addon-{{ block.id }}" class="product-addon__label">
        <div class="product-addon__content">
          <input 
            type="checkbox" 
            id="addon-{{ block.id }}"
            name="addon-{{ block.id }}"
            class="product-addon__checkbox"
            data-addon-checkbox
            value="{{ addon_variant.id }}"
          />
          
          <div class="product-addon__details">
            <h4 class="product-addon__product-title">{{ addon_product.title }}</h4>
            <div class="product-addon__price">
              <span class="product-addon__current-price">{{ addon_price | money }}</span>
              {% if addon_compare_price and addon_compare_price > addon_price %}
                <span class="product-addon__compare-price">{{ addon_compare_price | money }}</span>
              {% endif %}
            </div>
          </div>

          {% if addon_image %}
            <div class="product-addon__image">
              {{ addon_image | image_url: width: 80 | image_tag: 
                loading: 'lazy',
                alt: addon_product.title,
                width: 80,
                height: 80
              }}
            </div>
          {% endif %}
        </div>
      </label>
    </div>
  </div>

  <script src="{{ 'product-addon.js' | asset_url }}" defer></script>

{% endif %}

{% stylesheet %}
  .product-addon {
    margin-block: 16px;
    background: var(--color-background);
  }

  .product-addon__title {
    margin: 0 0 12px 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--color-foreground);
  }

  .product-addon__item {
    position: relative;
  }

  .product-addon__checkbox {
    width: 18px;
    height: 18px;
    margin: 0;
    cursor: pointer;
    accent-color: var(--color-primary);
  }

  .product-addon__label {
    display: block;
    cursor: pointer;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    padding: 12px 16px;
    transition: all 0.2s ease;
  }

  .product-addon__label:hover {
    border-color: var(--color-primary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .product-addon__content {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .product-addon__image {
    flex-shrink: 0;
    width: 60px;
    height: 60px;
    border-radius: 4px;
    overflow: hidden;
    order: 3;
  }

  .product-addon__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-addon__details {
    flex: 1;
    min-width: 0;
    order: 2;
  }

  .product-addon__product-title {
    margin: 0 0 4px 0;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--color-foreground);
    line-height: 1.3;
  }

  .product-addon__price {
    display: flex;
    align-items: baseline;
    gap: 8px;
  }

  .product-addon__current-price {
    font-weight: 600;
    color: var(--color-foreground);
  }

  .product-addon__compare-price {
    font-size: 0.85em;
    color: var(--color-foreground-muted);
    text-decoration: line-through;
  }

  /* Responsive adjustments */
  @media screen and (max-width: 749px) {
    .product-addon__content {
      gap: 10px;
    }
    
    .product-addon__image {
      width: 50px;
      height: 50px;
    }
    
    .product-addon__product-title {
      font-size: 0.85rem;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Product Add-on",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show title",
      "default": true
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Add-ons"
    },
    {
      "type": "product",
      "id": "addon_product",
      "label": "Add-on product"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-start",
      "label": "Left",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-inline-end",
      "label": "Right",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Product Add-on"
    }
  ]
}
{% endschema %}
